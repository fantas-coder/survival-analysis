# Оценка функции выживаемости по неполной статистической информации

## 1. Обзор проекта

### Контекст и актуальность
В реальных условиях данные о наступлении критических событий (отказ оборудования, время до рецидива заболевания и т.д.) часто оказываются:
- **Неполными** (цензурированными)
- **Зашумленными**
- **Частично наблюдаемыми**

Традиционные методы статистического анализа в таких случаях дают смещённые оценки. Данный проект предлагает комплексное решение для работы с цензурированными данными.

### Ключевые понятия

**Функция выживаемости** (Survival Function):
```math
S(t) = P(T > t) = 1 - F(t),
```
где:
* ```T``` - время до наступления события
* ```F(t)``` - кумулятивная функция распределения

Цензурирование данных - явление, когда точное время события неизвестно, но известны границы:
- **Правостороннее**: событие произошло после времени ```t```
- **Левостороннее**: событие произошло до времени ```t```
- **Интервальное**: событие в промежутке ```[t₁, t₂]```
  
### Функциональность

Этот проект реализует методы оценки функции выживаемости по цензурированным данным. Основные возможности:
* Генерация выборок из различных распределений (Вейбулла, Логнормального, Гамма)
* Моделирование различных типов цензурирования (правостороннего, интервального, левостороннего)
* Построение оценки Каплана-Мейера и её доверительного интервала
* Расчет ядерных оценок плотности с различными типами ядер (Гауссовское, Прямоугольное, Епонечникова, Биквадратное)
* Визуализация результатов и сравнение с теоретическими распределениями
* Исследование зависимости точности оценок от параметров цензурирования (Доля, Порог, Тип, Глубина)

## 2. Структура проекта
```
project-root/
│
├── analytics/           # Пакет с функциями для анализа
│ ├── init.py            # Инициализация пакета
│ ├── censoring.py       # Механизмы цензурирования данных
│ ├── distributions.py   # Генераторы распределений
│ ├── kaplan_meyer.py    # Оценка Каплана-Мейера
│ ├── kde.py             # Ядерные оценки плотности
│ ├── kernels.py         # Реализация ядерных функций
│ ├── plotting.py        # Визуализация результатов
│ └── utils.py           # Вспомогательные утилиты
│
├── graphics/            # Отдельный модуль визуализации
│ └── graphics.py        # Построение графиков из результатов
│
├── main.py              # Точка входа для запуска анализа
└── requirements.txt     # Зависимости Python
```

## 3. Установка и запуск

### Требования
- **Python**: версия 3.8 или новее
- **ОС**: Windows 10+/Linux/macOS

### Установка 
```bash
# Клонировать репозиторий
git clone https://github.com/yourusername/survival-analysis.git
cd survival-analysis

# Установить зависимости
pip install -r requirements.txt
```

## 4. Основные шаги

### 4.1 Генерация данных (`distributions.py`, `plotter.py`)
- Генерирует выборки из параметрических распределений (Вейбулла, Логнормального, Гамма)
- Визуализирует гистограмму распределения и функцию выживаемости
- Пример вызова:
  ```python
  data = generator.generate_sample(n=10, distribution="weibull", shape=3, scale=2, loc=0)
  
  plotter.paint_distribution_hist(data, "weibull")
  plt.show()
  print(f"Сгенерированная выборка:\n{data}")
  plotter.paint_distribution_time_life(data)
  plt.show()
  ```
- Визуализация:
![image](https://github.com/user-attachments/assets/1b62d914-39e5-456b-baec-d5d027de5327)
*Рисунок 1 – Гистограмма для данных из распределения W(0,3,2) для количества объектов n = 100.*
![image](https://github.com/user-attachments/assets/ae2d7ff6-5f38-40a9-be5a-52967ec5b855)
*Рисунок 2 – Распределение времени рождения и смерти для распределения W(0,3,2) для количества объектов n = 10.*

### 4.2 Цензурирование (`censoring.py`, `plotter.py`)
- Реализует три типа цензурирования:
  1. Пороговое (threshold)
  2. Случайное (random) с контролем долей каждого типа
  3. С регулируемой глубиной (coeff)
- Возвращает цензурированную выборку с метаданными
- Визуализирует распределение времени рождения и смерти с цензурированными данными
- Пример вызова:
  ```python
  data = censor.threshold_censoring(data, threshold=5)
  data = censor.random_censoring(data, l_share=0.2 i_share=0.2, r_share=0.1, threshold=4, coeff=1/3)
  
  print(f"Цензурированная выборка:\n{data}")
  plotter.paint_distribution_time_life(data)
  plt.show()
  ```
- Визуализация:
![image](https://github.com/user-attachments/assets/63be2964-fc86-4adf-a69e-c94524f33ee4)
*Рисунок 3 – Распределение времени рождения и смерти для W(0,3,2) для количества объектов n = 20. Порог цензурирования – 4, доля правого цензурирования – 0,2; левого – 0,2; интервального – 0,2.*

### 4.3 Оценка Каплана-Мейера (`kaplan_meyer.py`, `plotter.py`)
- Строит непараметрическую оценку функции выживаемости
- Рассчитывает доверительные интервалы по Гринвуду
- Визуализирует оценку Каплана-Мейера и сравнивает с теоретической кривой через метрики качества
- Пример вызова:
  ```python
  s_mark = km.kaplan_mayer_mark(data)
  print(f"Оценка Каплана-Мейера:\n{s_mark}")
  
  if not s_mark.empty and len(s_mark) > 1:
    confidence_interval = km.greenwood_confidence_interval(data, s_mark, alpha=0.05)
  
    plotter.paint_confidence_interval_with_kaplan_mayer(confidence_interval, s_mark)
    x_mass, true_value = plotter.add_distribution_on_plot("weibull", max_size=max(s_mark.index), shape=3, scale=2, loc=0)
  
    plotter.get_metrics_for_kaplan(x_mass, s_mark, true_value)
    plt.show()
  ```
- Визуализация:
![image](https://github.com/user-attachments/assets/3fd2eb14-13c6-4f8a-a574-5ea6364d4948)
*Рисунок 4 – Оценка Каплана-Мейера для W(0,3,2) для количества объектов n = 100. Порог цензурирования = 5, доля правого цензурирования = 0,2.*

### 4.4 Ядерные оценки (`kde.py`, `kernels.py`, `plotter.py`)
- Реализует 4 типа ядерных оценок плотности в зависимости от ядра:
  1. Гауссовское ядро
  2. Прямоугольное ядро
  3. Ядро Епанечникова
  4. Биквадратное ядро
- Интегрирует полученные оценки плотности (для получения оценки функции выживаемости)
- Визуализирует ядерную оценку и сравнивает с теоретической кривой через метрики качества
- Пример вызова:
  ```python
  x_gauss, y_gauss, sd_gauss = kde.calculate_kde(data, 'gauss', max_sample_size, NUM_POINTS_FOR_KDE)
  y_gauss_integral = plotter.paint_integrated_kernel_mark(x_gauss, y_gauss, sd_gauss, "Интеграл от ядерной оценки с Гауссовским ядром", color="red")
  x_mass, true_value = plotter.add_distribution_on_plot(distribution_name, max_size=max_sample_size, **kwargs, points_number=NUM_POINTS_FOR_KDE)
  
  plotter.get_metrics_for_kde(x_mass, y_gauss_integral, true_value, "Gaussian", color="red")
  plt.show()
  ```
- Визуализация:
![image](https://github.com/user-attachments/assets/6d7c8c64-0c94-475f-b383-f245a038eec5)
*Рисунок 5 – Интеграл от ядерной оценки плотности для W(0,3,2) для количества объектов n = 100. Порог цензурирования – 5, доля правого цензурирования – 0,1; левого – 0,1; интервального – 0,1.*

## 6. Результаты исследования

### 6.1 Метрики оценки
| Метрика | Формула | Интерпретация |
|---------|---------|---------------|
| **Максимум модуля разности** (MMD) | $\max \| \hat{S}(t) - S(t) \|$ | Максимальное отклонение оценки от теоретической кривой |
| **Корень среднеквадратичного отклонения** (SMSE) | $\sqrt{\frac{1}{n}\sum(\hat{S}(t)-S(t))^2}$ | Средняя точность оценки на всем интервале |

### 6.2 Параметры цензурирования

#### 1. Доля цензурирования (0-100%)
**Что означает**:  
Процент наблюдений, подвергшихся цензурированию  
**Пример**:  
![image](https://github.com/user-attachments/assets/6d49d312-6613-44a0-8c1c-b9bdbe9a22a4)
*Рисунок 6 – Зависимость значения MMD от доли цензурирования для W(0,3,2) для количества объектов n = 100, при использовании только правостороннего цензурирования.*
![image](https://github.com/user-attachments/assets/965363ff-2fb7-44a6-83c3-da177ac01d83)
*Рисунок 7 – Зависимость значения SMSE от доли цензурирования для W(0,3,2) для количества объектов n = 100, при использовании только правостороннего цензурирования.*

#### 2. Порог цензурирования
**Что означает**:  
Граничное значение времени наблюдения (Время конца эксперимента)  
**Пример**:
![image](https://github.com/user-attachments/assets/48679590-4d84-469e-8d6c-2553ffa05caa)
*Рисунок 8 – Зависимость значения SMSE от порога цензурирования для W(0,3,2) для количества объектов n = 100, при использовании только правостороннего цензурирования.*

#### 3. Тип цензурирования
**Что означает**:  
Доля цензурированных данных постоянная, меняется соотношение между видами  
**Пример**:  
| Тип | Характерные искажения |
|------|-----------------------|
| **Правостороннее** | Завышение значений метрик |
| **Левостороннее** | Слабое влияние |
| **Интервальное** | Улучшение точности оценивания |

#### 4. Глубина цензурирования
**Что означает**:  
Папраметр, отвечающий за моделирование цензурирование. При `coeff = 0` самые широкие интервалы. При `coeff = 0` самые узкие.  
Пример с правосторонним цензурированием, где нужно сгенерировать значение левой границы `l`:  
`l` из `U[a + (b-a)*coeff; b]`:  
- если `coeff = 0`, то `l` из `U[a; b]`
- если `coeff = 1`, то `l` из `U[b; b]`
**Пример**:
![image](https://github.com/user-attachments/assets/9d2b9b99-323a-42b7-85b2-fa184cc79a7e)
*Рисунок 9 – Зависимость значения SMSE от глубины цензурирования для W(0,3,2) для количества объектов n = 100, при использовании всех видов цензурирования.*  

## 7. Ключевые выводы
### Оценка Каплана-Мейера:  
**Плюсы:**  
- Хорошо работает на малых и средних долях цензурирования (0 - 60%)
- Имеет доверительный интервал
- Отлично работает при малом времени продолжительности эксперимента

**Минусы:**  
- Плохо работает с интервальным и левосторонним видами цензурирования
- Плохо работает на сильном цензурировании (> 60%)
- Не гладкая
### Ядерная оценка от Гауссовского ядра:  
**Плюсы:**  
- Бесконечно определённое ядро обеспечивает гладкость и плавный вид оценки

**Минусы:**  
- Большое значение метрик по сравнению с другими ядрами (особенно для выборок из Логнормального и Гамма распределений)
### Ядерная оценка от Прямоугольного ядра:  
**Плюсы:**  
- Очень хорошие значения метрик  

**Минусы:**  
- Слишком простая и не гладкая
### Ядерная оценка от ядер Епанечникова и Биквадратного:  
**Плюсы:**  
- Достаточно гладкие (полиномы большой степени)
- Оптимальные по среднеквадратичному отклонению

**Минусы:**  
- Средние значения метрик (не самые лучшие, не самые худшие)  

### **Таким образом, хоть выбрать лучшую оценку и не получилось, знание сильных и слабых сторон каждой из них поможет эффективно решить любую задачу!**

# 8. Лицензия
## Лицензия 
📜 [MIT License](https://opensource.org/licenses/MIT)
